# 🇨🇳 国内服务器部署指南

## 🎯 方案选择

由于Vercel在国内访问可能受限，这里提供国内部署方案。

---

## ⚡ 方案1: 直接在你的服务器运行 (最简单)

### 优势
- ✅ 完全可控
- ✅ 国内访问快
- ✅ 不需要注册任何云服务
- ✅ 24小时运行,价格实时更新

### 步骤

#### 1️⃣ 安装依赖

```bash
cd D:\API\大宗商品价格监控
pip install -r requirements-server.txt
```

或者单独安装:
```bash
pip install flask==3.0.0
pip install flask-cors==4.0.0
pip install websocket-client==1.6.4
```

#### 2️⃣ 启动服务器

```bash
python server.py
```

你会看到:
```
============================================================
🚀 大宗商品价格监控服务器启动中...
============================================================
📅 启动时间: 2025-10-20 15:30:00
🌐 访问地址: http://localhost:5000
📊 API地址: http://localhost:5000/api/prices
============================================================
[2025-10-20 15:30:03] WebSocket连接成功
[2025-10-20 15:30:05] 更新价格: 黄金(买) = 971.0 CNY/g
[2025-10-20 15:30:05] 更新价格: 白银(买) = 11.76 CNY/g
```

#### 3️⃣ 测试

打开浏览器:
- **主页**: http://localhost:5000
- **API**: http://localhost:5000/api/prices

✅ **完成！本地可以访问了！**

---

## 🌐 让外网也能访问

### 选项A: 使用内网穿透 (最快)

#### 使用 ngrok (免费)

1. 下载 ngrok: https://ngrok.com/download
2. 运行:
   ```bash
   ngrok http 5000
   ```
3. 会得到一个公网地址:
   ```
   https://xxxx-xx-xx-xx-xx.ngrok-free.app
   ```

**优点**: 5分钟搞定
**缺点**: 域名每次重启会变

#### 使用 frp (自建)

如果你有公网服务器,可以用frp做内网穿透

---

### 选项B: 云服务器部署

#### 腾讯云轻量应用服务器

**价格**: 约60元/年 (学生价)

**步骤**:

1. **购买服务器**
   - 访问: https://cloud.tencent.com/
   - 选择"轻量应用服务器"
   - 地域: 国内任意
   - 镜像: Ubuntu 22.04

2. **连接服务器**
   ```bash
   ssh ubuntu@你的服务器IP
   ```

3. **安装Python和依赖**
   ```bash
   sudo apt update
   sudo apt install python3-pip python3-venv -y
   ```

4. **上传代码**
   ```bash
   # 方式1: 使用git
   git clone https://github.com/你的用户名/commodity-price-monitor.git
   cd commodity-price-monitor

   # 方式2: 使用scp从本地上传
   # 在你的本地电脑运行:
   scp -r "D:\API\大宗商品价格监控" ubuntu@你的服务器IP:/home/ubuntu/
   ```

5. **安装依赖**
   ```bash
   pip3 install -r requirements-server.txt
   ```

6. **运行服务器**
   ```bash
   python3 server.py
   ```

7. **配置防火墙**
   ```bash
   # 腾讯云控制台 → 防火墙 → 添加规则
   # 端口: 5000
   # 协议: TCP
   ```

8. **访问网站**
   ```
   http://你的服务器IP:5000
   ```

---

### 选项C: 使用Nginx反向代理

让网站运行在80端口(http://你的域名)

#### 1. 安装Nginx

```bash
sudo apt install nginx -y
```

#### 2. 配置Nginx

```bash
sudo nano /etc/nginx/sites-available/gold-monitor
```

粘贴以下内容:

```nginx
server {
    listen 80;
    server_name 你的域名.com;  # 改成你的域名

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 3. 启用配置

```bash
sudo ln -s /etc/nginx/sites-available/gold-monitor /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 4. 配置域名

在你的域名商后台:
```
类型: A
主机记录: @ (或 gold)
记录值: 你的服务器IP
```

#### 5. 访问网站

```
http://你的域名.com
```

---

## 🔄 让服务器后台运行

### 使用 screen (推荐)

```bash
# 安装screen
sudo apt install screen -y

# 创建新会话
screen -S gold-monitor

# 运行服务器
python3 server.py

# 按 Ctrl+A, 然后按 D 退出会话(服务器继续运行)

# 重新连接会话
screen -r gold-monitor
```

### 使用 systemd (开机自启)

#### 1. 创建服务文件

```bash
sudo nano /etc/systemd/system/gold-monitor.service
```

粘贴:

```ini
[Unit]
Description=Gold Price Monitor
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/commodity-price-monitor
ExecStart=/usr/bin/python3 /home/ubuntu/commodity-price-monitor/server.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 2. 启用服务

```bash
sudo systemctl daemon-reload
sudo systemctl enable gold-monitor
sudo systemctl start gold-monitor
```

#### 3. 查看状态

```bash
sudo systemctl status gold-monitor
```

#### 4. 查看日志

```bash
sudo journalctl -u gold-monitor -f
```

---

## 📊 部署对比

| 方案 | 难度 | 费用 | 速度 | 稳定性 |
|------|------|------|------|--------|
| 本地运行 | ⭐ | 免费 | 快 | 取决于你的电脑 |
| 内网穿透(ngrok) | ⭐ | 免费 | 中 | 一般 |
| 腾讯云服务器 | ⭐⭐ | ~60元/年 | 很快 | 很好 |
| 阿里云服务器 | ⭐⭐ | ~60元/年 | 很快 | 很好 |

---

## 🎯 推荐方案

### 如果只是自己用或测试:
**→ 本地运行 `python server.py`**

### 如果需要给客户访问:
**→ 腾讯云/阿里云服务器 (60元/年)**

### 如果需要快速展示:
**→ ngrok内网穿透 (5分钟搞定)**

---

## 🧪 快速测试

无论哪种方案,测试步骤都一样:

1. **测试API**
   ```
   http://你的地址/api/prices
   ```
   应该返回:
   ```json
   {
     "success": true,
     "data": [
       {"code": "AU9999_BUY", "price": 971.0, ...}
     ]
   }
   ```

2. **测试主页**
   ```
   http://你的地址
   ```
   应该看到6个价格卡片,实时更新

---

## ⚠️ 注意事项

### 安全性

如果部署到公网服务器:

1. **配置防火墙**
   ```bash
   sudo ufw enable
   sudo ufw allow 22    # SSH
   sudo ufw allow 80    # HTTP
   sudo ufw allow 443   # HTTPS
   ```

2. **配置HTTPS** (可选)
   ```bash
   sudo apt install certbot python3-certbot-nginx -y
   sudo certbot --nginx -d 你的域名.com
   ```

### 性能

- Flask默认是单线程,但我已经配置了 `threaded=True`
- 如果访问量大,可以用 gunicorn:
  ```bash
  pip install gunicorn
  gunicorn -w 4 -b 0.0.0.0:5000 server:app
  ```

---

## 🆘 常见问题

### Q: 运行server.py后,WebSocket一直连接失败?

**A**: 检查网络,确保能访问 `wss://rtjwbqt.jzj9999.com:8443`

### Q: 网页能打开,但价格不显示?

**A**:
1. 检查 `/api/prices` 是否返回数据
2. 查看服务器日志,看WebSocket是否成功

### Q: 服务器关闭后,网站就访问不了?

**A**: 使用 systemd 配置开机自启

---

## 📞 现在开始

**最快方式 (5分钟):**

```bash
cd D:\API\大宗商品价格监控
pip install flask flask-cors websocket-client
python server.py
```

打开浏览器: http://localhost:5000

**看到价格更新了吗?** 🎉

---

**需要帮你配置云服务器部署吗?告诉我你想用哪个方案!**
